<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>アカウント設定 | SNS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body{
      font-family:'Noto Sans JP',ui-sans-serif,system-ui,-apple-system,
                  BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",
                  Arial,"Noto Sans",sans-serif,"Apple Color Emoji",
                  "Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
    }
  </style>
</head>
<body class="bg-white text-black antialiased">

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white border-b border-gray-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <!-- ロゴ -->
      <div class="flex items-center gap-2 font-extrabold tracking-tight">
        <div class="w-9 h-9 rounded-full bg-blue-100 grid place-items-center">SNS</div>
        <span>Social</span>
      </div>
      <!-- ▼ ここを遷移先に変更 -->
      <nav class="ml-auto">
        <ul class="flex items-center gap-4 font-semibold">
          <li><a href="{{url_for('home.home')}}" class="px-2 py-1 hover:underline">ホーム</a></li>
          <li><a href="{{url_for('photograph.post')}}" class="px-2 py-1 hover:underline">投稿</a></li>
          <li><a href="{{url_for('personal_page.personal_page')}}" class="px-2 py-1 hover:underline">マイページ</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 py-8">
    <!-- アイコン編集（プレビュー付き） -->
    <div class="flex flex-col items-center mb-8">
      <div class="w-24 h-24 rounded-full border border-black/40 overflow-hidden grid place-items-center bg-white">
        <img id="avatarPreview" alt="アイコン画像" class="w-full h-full object-cover" src="">
      </div>
      <label class="mt-3 text-sm cursor-pointer">
        <input id="avatarInput" type="file" accept="image/*" class="hidden">
        <span class="px-4 py-2 border border-black rounded-full hover:bg-black hover:text-white transition">
          写真を編集
        </span>
      </label>
    </div>

    <!-- 設定フォーム -->
    <section class="bg-gray-50 border border-gray-200 rounded-2xl p-6 md:p-8">
      <h1 class="text-xl font-semibold text-center mb-6">アカウント設定</h1>

      <form class="space-y-6" action="#" method="post">
      <!-- ユーザー名 -->
      <div>
        <label class="block text-sm mb-2">ユーザー名</label>
        <p class="w-full border border-black/50 rounded px-3 py-2 bg-white text-black/80">
          {{ user.display_name }}
        </p>
      </div>

        <!-- 公開 / 非公開（残す） -->
        <fieldset>
          <legend class="block text-sm mb-2">公開 / 非公開</legend>
          <label class="relative inline-flex items-center cursor-pointer select-none">
            <input id="privacy" type="checkbox" class="sr-only peer" />
            <div class="w-12 h-7 border border-black rounded-full peer-checked:bg-black transition-colors"></div>
            <div class="absolute left-0.5 top-0.5 h-6 w-6 bg-white border border-black rounded-full transition-transform peer-checked:translate-x-5"></div>
            <span class="ml-3 text-sm">非公開にする</span>
          </label>
        </fieldset>

        <!-- ユーザーのGmail -->
        <div>
          <label class="block text-sm mb-2">ユーザーのGmail</label>
          <p class="w-full border border-black/50 rounded px-3 py-2 bg-white text-black/80">
            {{ user.email }}
          </p>
        </div>


        <!-- アカウント作成日 -->
        <div>
          <label class="block text-sm mb-2">アカウント作成日</label>
          <p class="w-full border border-black/50 rounded px-3 py-2 bg-white text-black/80">
            {% if user.created_at %}{{ user.created_at.strftime('%Y年%-m月%-d日') }}{% endif %}
          </p>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="reset" class="px-4 py-2 border border-black rounded hover:bg-black hover:text-white transition">リセット</button>
          <button type="submit" class="px-4 py-2 border border-black bg-black text-white rounded hover:opacity-80 transition">保存する</button>
        </div>
      </form>
    </section>
  </main>

  <!-- ▼ ページ最後：ログアウトボタン -->

<footer class="max-w-xl mx-auto px-4 pb-10">
  <hr class="border-black/10 my-8">
  <a href="{{ url_for('index.logout') }}"
     class="w-full block text-center py-2.5 border border-black rounded-lg hover:bg-black hover:text-white transition">
    ログアウト
  </a>
</footer>


  <script>
    // アイコン画像プレビュー
    (function(){
      const input = document.getElementById('avatarInput');
      const img   = document.getElementById('avatarPreview');
      if (input && img) {
        input.addEventListener('change', function(e){
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (evt) => { img.src = evt.target.result || ''; };
          reader.readAsDataURL(file);
        });
      }
    })();

    // ユーザー情報の取得（/api/user/me のJSONを想定）
    (function(){
      const $ = (id) => document.getElementById(id);
      const usernameEl = $('username');
      const createdAtEl = $('created_at');

      const formatJP = (s) => {
        const d = new Date(s);
        if (isNaN(d)) return s || '';
        return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
      };

      async function loadUser(){
        try {
          const res = await fetch('/api/user/me', { credentials: 'include' });
          if (!res.ok) throw new Error('Failed to fetch user');
          const data = await res.json();
          if (data.username) usernameEl.value = data.username;
          if (data.created_at) createdAtEl.value = formatJP(data.created_at);
          // もし data.avatar_url が返るなら初期アイコンに反映
          const avatar = document.getElementById('avatarPreview');
          if (data.avatar_url && avatar) avatar.src = data.avatar_url;
        } catch (e) {
          console.error('ユーザー情報取得エラー:', e);
        }
      }
      loadUser();
    })();

    // ▼ ログアウト処理：サーバのログアウトAPIがあれば叩き、最後に index.html へ遷移
    (function(){
      const btn = document.getElementById('logoutBtn');
      if(!btn) return;
      btn.addEventListener('click', async () => {
        try {
          // アプリで使っているトークン等があればここでクリア
          localStorage.clear();
          sessionStorage.clear();
          // サーバー側APIがある場合はPOST（無くてもエラーは無視して遷移）
          await fetch('/api/logout', { method:'POST', credentials:'include' }).catch(()=>{});
        } finally {
          location.href = 'index.html';
        }
      });
    })();

    document.getElementById('logoutBtn').addEventListener('click', () => {
    window.location.href = '/logout';
  });
  </script>
</body>
</html>