{% extends "base.html" %}
{% block content %}
  <main class="max-w-xl mx-auto px-0 py-2">
    <!-- アイコン編集（プレビュー付き） -->
    <div class="flex flex-col items-center mb-8">
      <div class="w-24 h-24 rounded-full border border-black/40 overflow-hidden grid place-items-center bg-white">
        <img id="avatarPreview" alt="アイコン画像" class="w-full h-full object-cover" src="">
      </div>
      <label class="mt-3 text-sm cursor-pointer">
        <input id="avatarInput" type="file" accept="image/*" class="hidden">
        <span class="px-4 py-2 border border-black rounded-full hover:bg-black hover:text-white transition">
          写真を編集
        </span>
      </label>
    </div>

    <!-- 設定フォーム -->
    <section class="bg-gray-50 border border-gray-200 rounded-2xl p-6 md:p-8">
      <h1 class="text-xl font-semibold text-center mb-6">アカウント設定</h1>

      <form class="space-y-6" action="#" method="post">
        <!-- ユーザー名 -->
        <div>
          <label for="username" class="block text-sm mb-2">ユーザー名</label>
          <input id="username" name="username" type="text" placeholder="example_user"
                 class="w-full border border-black/50 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black" />
        </div>

        <!-- 公開 / 非公開 -->
        <fieldset>
          <legend class="block text-sm mb-2">公開 / 非公開</legend>
          <label class="relative inline-flex items-center cursor-pointer select-none">
            <input id="privacy" type="checkbox" class="sr-only peer" />
            <div class="w-12 h-7 border border-black rounded-full peer-checked:bg-black transition-colors"></div>
            <div class="absolute left-0.5 top-0.5 h-6 w-6 bg-white border border-black rounded-full transition-transform peer-checked:translate-x-5"></div>
            <span class="ml-3 text-sm">非公開にする</span>
          </label>
        </fieldset>

        <!-- ユーザーのGmail -->
        <div>
          <label for="email" class="block text-sm mb-2">ユーザーのGmail</label>
          <input id="email" name="email" type="email" placeholder="you@example.com"
                 class="w-full border border-black/50 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black" />
        </div>

        <!-- アカウント作成日（表示のみ） -->
        <div>
          <label class="block text-sm mb-2">アカウント作成日</label>
          <input id="created_at" type="text" placeholder="YYYY年M月D日" readonly
                 class="w-full border border-black/50 rounded px-3 py-2 bg-white text-black/80" />
        </div>

        <!-- アクション -->
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="reset" class="px-4 py-2 border border-black rounded hover:bg-black hover:text-white transition">リセット</button>
          <button type="submit" class="px-4 py-2 border border-black bg-black text-white rounded hover:opacity-80 transition">保存する</button>
        </div>
      </form>
    </section>
  </main>
{% endblock %}

{% block scripts %}
<script>
  // アイコン画像プレビュー
  (function(){
    const input = document.getElementById('avatarInput');
    const img   = document.getElementById('avatarPreview');
    if (input && img) {
      input.addEventListener('change', function(e){
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => { img.src = evt.target.result || ''; };
        reader.readAsDataURL(file);
      });
    }
  })();

  // ユーザー情報の取得（/api/user/me のJSONを想定）
  (async function(){
    const $ = (id) => document.getElementById(id);
    const usernameEl = $('username');
    const createdAtEl = $('created_at');

    const formatJP = (s) => {
      const d = new Date(s);
      if (isNaN(d)) return s || '';
      return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
    };

    try {
      const res = await fetch('/api/user/me', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch user');
      const data = await res.json();
      if (data.username) usernameEl.value = data.username;
      if (data.created_at) createdAtEl.value = formatJP(data.created_at);
      const avatar = document.getElementById('avatarPreview');
      if (data.avatar_url && avatar) avatar.src = data.avatar_url;
    } catch (e) {
      console.error('ユーザー情報取得エラー:', e);
    }
  })();
</script>
{% endblock %}